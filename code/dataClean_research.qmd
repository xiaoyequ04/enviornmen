---
title: "dataClean"
format: html
editor: visual
execute:
  echo: false
author: 
  - name: 温莹莹
    affiliation: 
      - 中国社会科学院大学
  - name: 朱萌
    corresponding: true
    affiliation: 
      - 清华大学政治学系
  - name: 张亮
    affiliation: 
      - 中国社会科学院大学
---

```{r setup,include = FALSE,echo=FALSE}
set.seed(0609)
options (warn = -1)
# packbirth loading
library(pacman)
p_load("rio",
       "here",
       "scales",
       "car",
       "haven",
       "MASS",
       "modelsummary",
       "bruceR",
       "easystats",
       "dotwhisker",
       "DiagrammeR",
       "purrr")

cgss2021 <- readRDS("../data/cgss2021.rds")
cgss2021$participate <- as.factor(cgss2021$participate)
```

# regression
```{r}
#| label: list_variable
cm <-c(
  eva_local_z = "对地方政府的评价",
  eva_central_z = "对中央政府的评价",
  efficacyIn = "内部环境效能感",
  efficacyEx = "外部环境效能感",
  res_classr = "责任归因",
  pollut_perse = "环境感知度",
  enCare = "环境关注度",
  efficacyIn_std = "内部环境效能感(标准化)",
  res_classr_std = "责任归因(标准化)",
  pollut_perse_std = "环境感知度(标准化)",
  enCare_std = "环境关注度(标准化)",
  age = "年龄",
  female = "性别",
  party = "党派",
  edu = "受教育程度",
  socailLevel_now = "社会经济地位",
  imcomePer_level = "个人收入",
  race = "民族",
  rural = "城镇户口",
  health = "健康状况",
  marriage = "婚姻状况",
  media = "媒介使用",
  trustSystem_z = "系统信任"
)

ls_iv <- c("eva_central_z","eva_local_z")

ls_med <- c(
  "efficacyIn",
  "enCare",
  "res_classr",
  "pollut_perse"
)

ls_med_std <- c(
  "efficacyIn_std",
  "enCare_std",
  "res_classr_std",
  "pollut_perse_std")

ls_ov <- c("action","participate")

ls_cv <-
    c(
        "edu",
        "media",
        "age",
        "female",
        "socailLevel_now",
        "imcomePer_level",
        "party",
        "rural",
        "health",
        "race",
        "marriage"
    )

```
# code1
## directEffcet
```{r}
#| label: directeffect
#| eval: false
ls_direct_parti <- paste(ls_cv,collapse = " + ") %>%
  paste0("participate ~ ",ls_iv," + ",.)

glm_direct_parti <- map(ls_direct_parti, ~ glm(.,data = cgss2021,family = binomial))

names(glm_direct_parti) <- c("环境抗争行为(中央)","环境抗争行为(地方)")

modelsummary(glm_direct_parti,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)

fig1 <- dwplot(glm_direct_parti[[1]]) %>% 
    relabel_predictors(c(
        eva_central_z = "对中央政府的评价",
        # eva_local_z = "对地方政府的评价",
        media = "媒体使用",
        age = "年龄",
        female = "性别",
        party = "党派",
        edu = "受教育程度",
        socailLevel_now = "社会经济地位",
        imcomePer_level = "个人收入",
        race = "民族",
        rural = "城镇户口",
        health = "健康状况",
        marriage = "婚姻状况")) +
  geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw(base_size = 4) + 
  xlab("相关系数") + 
  ylab("") +
  ggtitle("中央政府评价对环境行为的影响") + 
  theme_set(theme_gray(base_family = "STKaiti")) +
  labs(caption = "来源：2021年中国社会综合调查。") +
  theme(legend.position = "none") +
    scale_colour_grey(
        start = .3,
        end = .7)
fig1

```

## medEffect

### cen2med
```{r}
#| label: cen2med
#| eval: false
lm_med_cen <- paste(ls_cv,collapse = " + ") %>%
  paste0(ls_med," ~ eva_central_z + ",.)

lm_cen2med <- map(lm_med_cen,~ lm(.,data = cgss2021))

names(lm_cen2med) <- c("环境效能感","环境关注度","责任归因","环境感知度")

modelsummary(lm_cen2med,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)
```

### local2med
```{r}
#| label: local2med
#| eval: false
lm_med_local <- paste(ls_cv,collapse = " + ") %>%
  paste0(ls_med," ~ eva_local_z + ",.)

lm_local2med <- map(lm_med_local,~ lm(.,data = cgss2021))

names(lm_local2med) <-  c("环境效能感","环境关注度","责任归因","环境感知度")

modelsummary(lm_local2med,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)
```



## totalEffect
### cen2parti
```{r}
#| label: cen2parti
#| eval: false
glm_cen_total <- paste(ls_cv,collapse = " + ") %>%
  paste0("participate"," ~ eva_central_z + ",
         paste(ls_med,collapse = " + "), 
         " + ",
         .)

glm_cen2parti_total <- map(glm_cen_total,~ glm(.,family = binomial,data = cgss2021))

names(glm_cen2parti_total) <- c("总效应")

modelsummary(glm_cen2parti_total,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)
```

## mediation analysis
```{r}
#| label: mediation analysis
#| eval: false
med_cen_care_parti <- mediation::mediate(
  model.m = lm_cen2med[[1]],
  model.y = glm_cen2parti_total[1],
  treat = "eva_central_z",
  mediator = "efficacyIn",
  sims = 1000,
  robustSE = TRUE,
  dropobs = TRUE)

result_mediationIn <- map2(
  lm_cen2med,
  ls_med,
  ~ mediation::mediate(
    model.y = glm_cen2parti_total[[1]],
    model.m = .x,
    treat = "eva_central_z",
    mediator = .y,
    # boot = TRUE,
    sims = 1000,
    robustSE = TRUE, 
    dropobs = TRUE
  )
)


```







# code2_participate

## Directeffect
```{r}
#| label: direct
ls_direct_cen2parti <- paste(ls_cv,collapse = " + ") %>%
  paste0("participate ~ ","eva_central_z +",.)
glm_direct_cen2parti <- glm(ls_direct_cen2parti,family = binomial,data = cgss2021)

ls_direct_local2parti <- paste(ls_cv,collapse = " + ") %>%
  paste0("participate ~ ","eva_local_z +",.)
glm_direct_local2parti <- glm(ls_direct_local2parti,family = binomial,data = cgss2021)

mlist_direct_par <- list(
  "环境行为(中央)" = glm_direct_cen2parti,
  "环境行为(地方)" = glm_direct_local2parti
)

modelsummary(mlist_direct_par,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)

plot_direct_par <- dwplot(
  mlist_direct_par,
  vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2)) %>%
  relabel_predictors(
    c(
      eva_central_z = "对中央政府的评价",
      eva_local_z = "对地方政府的评价",
      edu = "受教育程度",
      socailLevel_now = "社会经济地位",
      media = "媒介使用",
      age = "年龄",
      female = "性别",
      party = "党派",
      imcomePer_level = "个人收入",
      race = "民族",
      rural = "城镇户口",
      health = "健康状况",
      marriage = "婚姻状况"
    )
  ) + 
  theme_bw(base_size = 4) +
  xlab("相关系数") + 
  ylab("") +
  ggtitle("政治信任对环境抗争行为的影响") + 
  theme_set(theme_gray(base_family = "STKaiti")) +
  labs(caption = "来源：2021年中国社会综合调查。") +
  theme(
        plot.title = element_text(face = "bold"),
        legend.position = "right",
        legend.justification = c(0, 0),
        legend.background = element_rect(colour = "grey80"),
        legend.title = element_blank()
    ) +
  scale_colour_grey(
    start = .3,
    end = .7,
    breaks = c("环境行为(地方)", "环境行为(中央)"),
    labels = c("对地方政府的评价","对中央政府的评价")
    ) +
  scale_shape_discrete(
    breaks = c("对地方政府的评价", "对中央政府的评价"),
    labels = c("对地方政府的评价",  "对中央政府的评价")
    ) +
    guides(
      shape = guide_legend(), 
      colour = guide_legend()
    )
plot_direct_par
```

## Mediaeffct

### cen2med
```{r}
#| label: indirect_cen
med_cen2In <- paste(ls_cv,collapse = " + ") %>%
  paste0("efficacyIn"," ~ eva_central_z + ",.)
lm_med_cen2In <- lm(med_cen2In,data = cgss2021)

med_cen2res <- paste(ls_cv,collapse = " + ") %>%
  paste0("res_classr"," ~ eva_central_z + ",.)
lm_med_cen2res <- lm(med_cen2res,data = cgss2021)

med_cen2per <- paste(ls_cv,collapse = " + ") %>%
  paste0("pollut_perse"," ~ eva_central_z + ",.)
lm_med_cen2per <- lm(med_cen2per,data = cgss2021)

med_cen2care <- paste(ls_cv,collapse = " + ") %>%
  paste0("enCare"," ~ eva_central_z + ",.)
lm_med_cen2care <- lm(med_cen2care,data = cgss2021)

mlist_cen2med <- list(
  "内部效能感" = lm_med_cen2In,
  "环境关注度" = lm_med_cen2care,
  "责任感归因" = lm_med_cen2res,
  "环境感知" = lm_med_cen2per
)

modelsummary(mlist_cen2med,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)

```

### local2med
```{r}
#| label: indirect_local
med_local2In <- paste(ls_cv,collapse = " + ") %>%
  paste0("efficacyIn"," ~ eva_local_z + ",.)
lm_med_local2In <- lm(med_local2In,data = cgss2021)

med_local2res <- paste(ls_cv,collapse = " + ") %>%
  paste0("res_classr"," ~ eva_local_z + ",.)
lm_med_local2res <- lm(med_local2res,data = cgss2021)

med_local2per <- paste(ls_cv,collapse = " + ") %>%
  paste0("pollut_perse"," ~ eva_local_z + ",.)
lm_med_local2per <- lm(med_local2per,data = cgss2021)

med_local2care <- paste(ls_cv,collapse = " + ") %>%
  paste0("enCare"," ~ eva_local_z + ",.)
lm_med_local2care <- lm(med_local2care,data = cgss2021)

mlist_local2med <- list(
  "内部效能感" = lm_med_local2In,
  "环境关注度" = lm_med_local2care,
  "责任感归因" = lm_med_local2res,
  "环境感知" = lm_med_local2per
)

modelsummary(mlist_local2med,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)

```

## totaleffect
```{r}
#| label: total
ls_total_local2parti <- paste(ls_cv,collapse = " + ") %>%
  paste0("participate"," ~ eva_local_z + ",
         paste(ls_med,collapse = " + "),
         " + ",
         .)
glm_total_local2parti <- glm(ls_total_local2parti,family = binomial,data = cgss2021)

ls_total_cen2parti <- paste(ls_cv,collapse = " + ") %>%
  paste0("participate"," ~ eva_central_z + ",
         paste(ls_med,collapse = " + "),
         " + ",
         .)
glm_total_cen2parti <- glm(ls_total_cen2parti,family = binomial,data = cgss2021)

mlist_total <- list(
  "总效应(中央)" = glm_total_cen2parti,
  "总效应(地方)" = glm_total_local2parti
)

modelsummary(mlist_total,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)
```

## median analysis
```{r}
result_cen2par <- map2(
  mlist_cen2med,
  ls_med,
  ~ mediation::mediate(
    model.y = mlist_total[[1]],
    model.m = .x,
    treat = "eva_central_z",
    mediator = .y,
    sims = 1000,
    robustSE = TRUE, 
    dropobs = TRUE
  )
)

result_local2par <- map2(
  mlist_local2med,
  ls_med,
  ~ mediation::mediate(
    model.y = mlist_total[[2]],
    model.m = .x,
    treat = "eva_local_z",
    mediator = .y,
    sims = 1000,
    robustSE = TRUE, 
    dropobs = TRUE
  )
)

result_mediation_par <- list(central2par = result_cen2par, local2par = result_local2par)

qsave(result_mediation_par, "../outputs/result_mediation_par.qs", preset = "archive")
```

## plot
### participate
```{r}
df_resultMed <- map(result_mediation_par, function(aGroup) {
  map2_df(aGroup, ls_med, function(aResult, aMediator) {
    tibble(
      mediator = aMediator,
      effect = "aceB",
      estimate = aResult$d.avg,
      p.value = aResult$d.avg.p,
      conf.low = aResult$d.avg.ci[1],
      conf.high = aResult$d.avg.ci[2],
      prop = scales::percent(aResult$n.avg)
    ) %>%
      bind_rows(
        tibble(
          mediator = aMediator,
          effect = "ade",
          estimate = aResult$z.avg,
          p.value = aResult$z.avg.p,
          conf.low = aResult$z.avg.ci[1],
          conf.high = aResult$z.avg.ci[2],
          prop = ""
        )
      ) %>%
      bind_rows(
        tibble(
          mediator = aMediator,
          effect = "total",
          estimate = aResult$tau.coef,
          p.value = aResult$tau.p,
          conf.low = aResult$tau.ci[1],
          conf.high = aResult$tau.ci[2],
          prop = ""
        )
      )
  })
})

df_totalMed <- map_dbl(df_resultMed, function(aData) {
 filter(aData, effect == "aceB") %>%
  mutate(estimate = ifelse(p.value < 0.05, abs(estimate), 0)) %>%
  # calculating the sig effects
  summarise(total = sum(estimate)) %>%
  pull(total)
})

df_resultMed <- map2(df_resultMed, df_totalMed,
                      ~mutate(.x, propAceB = abs(estimate)/.y,
                              propAceB = scales::percent(propAceB)))

df_plot_mediation <- map(df_resultMed, function(aData){
 aData %>%
 filter(effect != "total") %>%
 mutate(
  across(where(is.numeric), ~ round(., digits = 3)),
  sig = p.value < 0.05,
  conf.low = ifelse(
   p.value < 0.05 & 
    estimate < 0 &
    !str_detect(conf.low, "^\\-"),
   paste0("-", as.character(conf.low)),
   as.character(conf.low)
  ),
  # make sure minus for 0s
  conf.high = ifelse(
   p.value < 0.05 & 
    estimate < 0 & 
    !str_detect(conf.high, "^\\-"),
   paste0("-", as.character(conf.high)),
   as.character(conf.high)
  ),
  mediator_lab = rep(
   c(
    "环境效能感",
    "环境关注度",
    "责任归因",
    "环境感知"
   ),
   each = 2
  ),
  mediator_lab = 
   ifelse(effect == "aceB",
          paste0(
    mediator_lab,
    "\n ",
    estimate,
    "\n [",
    conf.low,
    ", ",
    conf.high,
    "]"), 
    paste0(
    estimate,
    "\n [",
    conf.low,
    ", ",
    conf.high,
    "]")),
  prop = ifelse(sig, propAceB, ""),
  arrow = ifelse(sig, propAceB, ""),
  lineStyle = ifelse(sig, "solid", "dashed")
 )
})



plot_mediation_parti <- grViz(diagram = 
       "digraph {
 
 graph [layout = dot, rankdir = LR]

 node [shape = box]
 edge [arrowhead = vee]
 
 a [label = '对中央政府的评价']
 b [label = '@@1-1']
 c [label = '@@1-2']
 d [label = '@@1-3']
 e [label = '@@1-4']
 g [label = '环境行为']

 h [label = '对地方政府的评价']
 i [label = '@@5-1']
 j [label = '@@5-2']
 k [label = '@@5-3']
 l [label = '@@5-4']
 n [label = '环境行为']

 a -> b
 a -> c
 a -> d
 a -> e
 
 b -> g [style = '@@2-1', label = '@@3-1']
 c -> g [style = '@@2-2', label = '@@3-2']
 d -> g [style = '@@2-3', label = '@@3-3']
 e -> g [style = '@@2-4', label = '@@3-4']
 
 a -> g [style = 'dashed', label = '@@4-1']

 g -> h [style = 'invisible', arrowhead = 'none']

 h -> i
 h -> j
 h -> k
 h -> l
 
 i -> n [style = '@@6-1', label = '@@7-1']
 j -> n [style = '@@6-2', label = '@@7-2']
 k -> n [style = '@@6-3', label = '@@7-3']
 l -> n [style = '@@6-4', label = '@@7-4']
 
 h -> n [style = 'dashed', label = '@@8-1']
 
  }

[1]: df_plot_mediation$central2par$mediator_lab[df_plot_mediation$central2par$effect == 'aceB']
[2]: df_plot_mediation$central2par$lineStyle[df_plot_mediation$central2par$effect == 'aceB']
[3]: df_plot_mediation$central2par$arrow[df_plot_mediation$central2par$effect == 'aceB']
[4]: df_plot_mediation$central2par$mediator_lab[df_plot_mediation$central2par$effect == 'ade']
[5]: df_plot_mediation$local2par$mediator_lab[df_plot_mediation$local2par$effect == 'aceB']
[6]: df_plot_mediation$local2par$lineStyle[df_plot_mediation$local2par$effect == 'aceB']
[7]: df_plot_mediation$local2par$arrow[df_plot_mediation$local2par$effect == 'aceB']
[8]: df_plot_mediation$local2par$mediator_lab[df_plot_mediation$local2par$effect == 'ade']
") 
#   export_svg() %>% 
#   charToRaw() %>% 
#   rsvg_png("../outputs/plot_mediation_total.png")
# 
# include_graphics("../outputs/plot_mediation_total.png")
```








# code2_action

## Directeffect_action
```{r}
#| label: direct_action
ls_direct_cen2ac <- paste(ls_cv,collapse = " + ") %>%
  paste0("action ~ ","eva_central_z +",.)
lm_direct_cen2ac <- lm(ls_direct_cen2ac,data = cgss2021)

ls_direct_local2ac <- paste(ls_cv,collapse = " + ") %>%
  paste0("action ~ ","eva_local_z +",.)
lm_direct_local2ac <- lm(ls_direct_local2ac,data = cgss2021)

mlist_direct_action <- list(
  "亲环境行为(中央)" = lm_direct_cen2ac,
  "亲环境行为(地方)" = lm_direct_local2ac
)

modelsummary(mlist_direct_action,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)

```

:::{.callout-note collapse="true"}
1. 中央政府对亲环境行为不显著，因此后续无须做中介效应分析。
2. 地方政府对中介变量的回归已经在participate那一节做过，因此无需再做，只需要看总效应即可。
:::
## Mediaeffct_action

## totaleffect_action
```{r}
#| label: total
ls_total_local2ac <- paste(ls_cv,collapse = " + ") %>%
  paste0("action"," ~ eva_local_z + ",
         paste(ls_med,collapse = " + "),
         " + ",
         .)
lm_total_local2ac <- lm(ls_total_local2ac,data = cgss2021)

mlist_total_action <- list(
  "总效应(地方)" = lm_total_local2ac
)

modelsummary(mlist_total_action,
             stars = TRUE,
             coef_omit = "(Intercept)",
             coef_rename = cm)
```
:::{.callout-important collapse="false"}
1. 总效应结果显示，所有中介变量加进去后，地方政府评价的显著性只达到90%，这说明中介效应稀释了直接效应。不过环境感知度中介效应不明显，这说明环境感知对亲环境行为并没有影响。
:::
## median analysis
```{r}
result_local2ac <- map2(
  mlist_local2med,
  ls_med,
  ~ mediation::mediate(
    model.y = mlist_total_action[[1]],
    model.m = .x,
    treat = "eva_local_z",
    mediator = .y,
    sims = 1000,
    robustSE = TRUE, 
    dropobs = TRUE
  )
)

df_resultMed_local2ac <- tibble(
  mediator = result_local2ac[[1]]$mediator,
  effect = "aceB",
  estimate = result_local2ac[[1]]$d.avg,
  p.value = result_local2ac[[1]]$d.avg.p,
  conf.low = result_local2ac[[1]]$d.avg.ci[1],
  conf.high = result_local2ac[[1]]$d.avg.ci[2],
  prop = scales::percent(result_local2ac[[1]]$n.avg)
  ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[1]]$mediator,
      effect = "ade",
      estimate = result_local2ac[[1]]$z.avg,
      p.value = result_local2ac[[1]]$z.avg.p,
      conf.low = result_local2ac[[1]]$z.avg.ci[1],
      conf.high = result_local2ac[[1]]$z.avg.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[1]]$mediator,
      effect = "total",
      estimate = result_local2ac[[1]]$tau.coef,
      p.value = result_local2ac[[1]]$tau.p,
      conf.low = result_local2ac[[1]]$tau.ci[1],
      conf.high = result_local2ac[[1]]$tau.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[2]]$mediator,
      effect = "aceB",
      estimate = result_local2ac[[2]]$d.avg,
      p.value = result_local2ac[[2]]$d.avg.p,
      conf.low = result_local2ac[[2]]$d.avg.ci[1],
      conf.high = result_local2ac[[2]]$d.avg.ci[2],
      prop = scales::percent(result_local2ac[[2]]$n.avg))
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[2]]$mediator,
      effect = "ade",
      estimate = result_local2ac[[2]]$z.avg,
      p.value = result_local2ac[[2]]$z.avg.p,
      conf.low = result_local2ac[[2]]$z.avg.ci[1],
      conf.high = result_local2ac[[2]]$z.avg.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[2]]$mediator,
      effect = "total",
      estimate = result_local2ac[[2]]$tau.coef,
      p.value = result_local2ac[[2]]$tau.p,
      conf.low = result_local2ac[[2]]$tau.ci[1],
      conf.high = result_local2ac[[2]]$tau.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[3]]$mediator,
      effect = "aceB",
      estimate = result_local2ac[[3]]$d.avg,
      p.value = result_local2ac[[3]]$d.avg.p,
      conf.low = result_local2ac[[3]]$d.avg.ci[1],
      conf.high = result_local2ac[[3]]$d.avg.ci[2],
      prop = scales::percent(result_local2ac[[3]]$n.avg))
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[3]]$mediator,
      effect = "ade",
      estimate = result_local2ac[[3]]$z.avg,
      p.value = result_local2ac[[3]]$z.avg.p,
      conf.low = result_local2ac[[3]]$z.avg.ci[1],
      conf.high = result_local2ac[[3]]$z.avg.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[3]]$mediator,
      effect = "total",
      estimate = result_local2ac[[3]]$tau.coef,
      p.value = result_local2ac[[3]]$tau.p,
      conf.low = result_local2ac[[3]]$tau.ci[1],
      conf.high = result_local2ac[[3]]$tau.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[4]]$mediator,
      effect = "aceB",
      estimate = result_local2ac[[4]]$d.avg,
      p.value = result_local2ac[[4]]$d.avg.p,
      conf.low = result_local2ac[[4]]$d.avg.ci[1],
      conf.high = result_local2ac[[4]]$d.avg.ci[2],
      prop = scales::percent(result_local2ac[[4]]$n.avg))
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[4]]$mediator,
      effect = "ade",
      estimate = result_local2ac[[4]]$z.avg,
      p.value = result_local2ac[[4]]$z.avg.p,
      conf.low = result_local2ac[[4]]$z.avg.ci[1],
      conf.high = result_local2ac[[4]]$z.avg.ci[2],
      prop = "")
    ) %>%
  bind_rows(
    tibble(
      mediator = result_local2ac[[4]]$mediator,
      effect = "total",
      estimate = result_local2ac[[4]]$tau.coef,
      p.value = result_local2ac[[4]]$tau.p,
      conf.low = result_local2ac[[4]]$tau.ci[1],
      conf.high = result_local2ac[[4]]$tau.ci[2],
      prop = "")
  )

df_mediation_local2ac <- df_resultMed_local2ac %>%
  filter(effect != "total") %>%
  mutate(
    across(where(is.numeric),~ round(.,3)),
    sig = p.value < 0.05,
    mediator_lab = rep(
      c(
        "环境效能感",
        "环境关注度",
        "责任归因",
        "环境感知度"),
      each = 2),
    mediator_lab = 
      ifelse(effect == "aceB",
             paste0(
               mediator_lab,
               "\n ",
               estimate,
               "\n [",
               conf.low,
               ", ",
               conf.high,
               "]"), 
             paste0(
               estimate,
               "\n [",
               conf.low,
               ", ",
               conf.high,
               "]"))
    )

df_mediation_local2ac <- df_mediation_local2ac %>%
  group_by(effect) %>%
  mutate(
    estimate_abs = ifelse(p.value < .05,abs(estimate),0),
    total = sum(estimate_abs),
    propAceB = estimate_abs/total,
    propAceB = scales::percent(propAceB),
    prop = ifelse(sig, propAceB, ""),
    arrow = ifelse(sig, propAceB, ""),
    lineStyle = ifelse(sig, "solid", "dashed"))

plot_mediation_local2ac <- grViz(diagram = 
       "digraph {
 graph [layout = dot, rankdir = LR]
 node [shape = box]
 edge [arrowhead = vee]
 
 a [label = '对地方政府的评价']
 b [label = '@@1-1']
 c [label = '@@1-2']
 d [label = '@@1-3']
 e [label = '@@1-4']
 g [label = '亲环境行为']

 a -> b
 a -> c
 a -> d
 a -> e
 
 b -> g [style = '@@2-1', label = '@@3-1']
 c -> g [style = '@@2-2', label = '@@3-2']
 d -> g [style = '@@2-3', label = '@@3-3']
 e -> g [style = '@@2-4', label = '@@3-4']
 
 a -> g [style = 'dashed', label = '@@4-1']
       }
[1]: df_mediation_local2ac$mediator_lab[df_mediation_local2ac$effect == 'aceB']
[2]: df_mediation_local2ac$lineStyle[df_mediation_local2ac$effect == 'aceB']
[3]: df_mediation_local2ac$arrow[df_mediation_local2ac$effect == 'aceB']
[4]: df_mediation_local2ac$mediator_lab[df_mediation_local2ac$effect == 'ade']
  ")
# 看[4]，可以知道这里显示的直接效应实际上就是第一个ade，但这样做是否正确？
summary(result_local2ac[[2]])
```
